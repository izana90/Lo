<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Chat</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #007AFF; /* iOS Blue */
            --bg: #F2F2F7;
            --chat-bg: #FFFFFF;
            --gray-bubble: #E5E5EA;
            --text-dark: #000000;
            --text-light: #FFFFFF;
        }

        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            background-color: var(--bg); 
            margin: 0; height: 100vh; 
            display: flex; flex-direction: column; 
            overflow: hidden;
        }

        /* LOGIN MODAL */
        #login-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000;
        }
        .card {
            background: white; padding: 30px; border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); width: 90%; max-width: 350px;
            text-align: center;
        }
        h2 { margin-top: 0; color: #333; }
        input, select {
            width: 100%; padding: 12px; margin: 8px 0;
            border: 1px solid #ddd; border-radius: 10px; font-size: 16px;
            box-sizing: border-box; outline: none;
        }
        input:focus { border-color: var(--primary); }
        .btn-main {
            width: 100%; padding: 12px; margin-top: 15px;
            background: var(--primary); color: white; border: none; border-radius: 10px;
            font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s;
        }
        .btn-main:active { transform: scale(0.98); }

        /* HEADER */
        header {
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            padding: 15px 20px; border-bottom: 1px solid #ddd;
            display: flex; justify-content: space-between; align-items: center;
            height: 60px; box-sizing: border-box;
        }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .avatar { 
            width: 35px; height: 35px; background: #ddd; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-size: 14px; color: #555; font-weight: bold;
        }
        .status-badge { font-size: 12px; color: #888; display: flex; align-items: center; gap: 5px; }
        .dot { width: 8px; height: 8px; background: #ccc; border-radius: 50%; }
        .dot.online { background: #34C759; }

        .settings select {
            padding: 5px 10px; border-radius: 15px; border: 1px solid #eee;
            font-size: 12px; background: #f9f9f9; color: #555;
        }

        /* CHAT AREA */
        #chat-area {
            flex: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 10px;
            background: white;
        }
        
        .message { max-width: 75%; padding: 10px 16px; border-radius: 20px; font-size: 15px; line-height: 1.4; position: relative; word-wrap: break-word; }
        
        .message.me {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message.partner {
            align-self: flex-start;
            background: var(--gray-bubble);
            color: black;
            border-bottom-left-radius: 4px;
        }

        .message img { max-width: 100%; border-radius: 10px; margin-top: 5px; }
        .sub-text { font-size: 11px; margin-top: 4px; opacity: 0.7; font-style: italic; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 4px; display: block; }
        .me .sub-text { border-top: 1px solid rgba(255,255,255,0.3); }

        /* TYPING BUBBLE */
        #typing-bubble {
            align-self: flex-start; background: var(--gray-bubble);
            padding: 10px 15px; border-radius: 20px; border-bottom-left-radius: 4px;
            display: none; width: fit-content;
        }
        .dots { display: flex; gap: 4px; }
        .dots span {
            width: 6px; height: 6px; background: #888; border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .dots span:nth-child(1) { animation-delay: -0.32s; }
        .dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* INPUT AREA */
        footer {
            padding: 15px; background: #F9F9F9; border-top: 1px solid #ddd;
            display: flex; gap: 10px; align-items: center;
        }
        #msg-input {
            flex: 1; padding: 12px 15px; border-radius: 25px; border: 1px solid #ddd;
            font-size: 15px; outline: none; transition: 0.3s;
        }
        #msg-input:focus { border-color: var(--primary); background: white; }
        .icon-btn {
            background: none; border: none; font-size: 20px; cursor: pointer; color: var(--primary); padding: 5px;
        }
        .icon-btn:hover { opacity: 0.8; }

    </style>
</head>
<body>

    <div id="login-modal">
        <div class="card">
            <h2>ðŸ’¬ Chat Login</h2>
            <input type="text" id="pass" placeholder="Enter Room Name (e.g. 'sky')">
            <select id="role">
                <option value="A">ðŸ‘¤ I am User A</option>
                <option value="B">ðŸ‘¤ I am User B</option>
            </select>
            <button class="btn-main" onclick="startApp()">Join Chat</button>
            <p style="font-size: 12px; color: #888; margin-top: 15px;">Both must enter exact same Room Name.</p>
        </div>
    </div>

    <header>
        <div class="user-info">
            <div class="avatar" id="avatar-initial">?</div>
            <div>
                <strong id="header-name">Partner</strong>
                <div class="status-badge"><span class="dot" id="status-dot"></span> <span id="status-text">Offline</span></div>
            </div>
        </div>
        <div class="settings">
            <select id="lang" onchange="localStorage.setItem('chat_lang', this.value)">
                <option value="none">Translate: Off</option>
                <option value="en">English</option>
                <option value="es">Spanish</option>
                <option value="fr">French</option>
                <option value="de">German</option>
                <option value="hi">Hindi</option>
                <option value="ja">Japanese</option>
            </select>
        </div>
    </header>

    <div id="chat-area">
        <div id="typing-bubble">
            <div class="dots"><span></span><span></span><span></span></div>
        </div>
    </div>

    <footer>
        <input type="file" id="img-upload" hidden accept="image/*" onchange="sendImg()">
        <button class="icon-btn" onclick="document.getElementById('img-upload').click()">ðŸ“·</button>
        <input type="text" id="msg-input" placeholder="iMessage..." onkeypress="handleEnter(event)" oninput="handleTyping()">
        <button class="icon-btn" onclick="send()">âž¤</button>
    </footer>

    <script>
        let peer, conn, myId, partnerId;
        let typingTimer;

        function startApp() {
            const pass = document.getElementById('pass').value.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
            const role = document.getElementById('role').value;
            
            if(!pass) return alert("Please enter a room name");

            // Setup IDs
            myId = pass + "-" + role;
            partnerId = pass + "-" + (role === "A" ? "B" : "A");

            // UI Update
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('avatar-initial').innerText = role;
            
            initPeer();
        }

        function initPeer() {
            setStatus("Connecting...", false);
            peer = new Peer(myId);

            peer.on('open', (id) => {
                setStatus("Waiting for partner...", false);
                connectToPartner(); // Attempt connection immediately
            });

            // When someone connects to US
            peer.on('connection', (c) => {
                setupConnection(c);
            });

            peer.on('error', (err) => console.log(err));
            peer.on('disconnected', () => peer.reconnect());
        }

        function connectToPartner() {
            if(conn) return;
            // We initiate connection
            let c = peer.connect(partnerId);
            if(c) setupConnection(c);
        }

        function setupConnection(c) {
            // If we already have a connection, ignore to prevent duplicate logic
            if(conn && conn.open) return;

            conn = c;

            conn.on('open', () => {
                setStatus("Online", true);
                // Send a handshake to ensure data path works
                conn.send({ type: 'handshake' });
            });

            conn.on('data', async (data) => {
                if (data.type === 'msg') {
                    // Handle Message + Translation
                    let subText = "";
                    const lang = document.getElementById('lang').value;
                    if(lang !== 'none' && !data.isImg) {
                        subText = await translate(data.content, lang);
                    }
                    addMessage(data.content, 'partner', data.isImg, subText);
                    
                    // If we receive a message, hide typing indicator immediately
                    toggleTyping(false); 
                } 
                else if (data.type === 'typing') {
                    toggleTyping(data.active);
                }
            });

            conn.on('close', () => {
                setStatus("Offline", false);
                conn = null;
                setTimeout(connectToPartner, 2000); // Retry loop
            });
        }

        // --- TYPING LOGIC ---
        function handleTyping() {
            if (conn && conn.open) {
                conn.send({ type: 'typing', active: true });
                
                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => {
                    if(conn && conn.open) conn.send({ type: 'typing', active: false });
                }, 1000);
            }
        }

        function toggleTyping(show) {
            const bubble = document.getElementById('typing-bubble');
            const chat = document.getElementById('chat-area');
            if(show) {
                bubble.style.display = 'block';
                chat.appendChild(bubble); // Move to bottom
                chat.scrollTop = chat.scrollHeight;
            } else {
                bubble.style.display = 'none';
            }
        }

        // --- MESSAGING ---
        function send() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text) return;

            addMessage(text, 'me', false);
            if(conn && conn.open) {
                conn.send({ type: 'msg', content: text, isImg: false });
                conn.send({ type: 'typing', active: false }); // Stop typing indicator
            }
            input.value = '';
        }

        function sendImg() {
            const file = document.getElementById('img-upload').files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = e.target.result;
                addMessage(img, 'me', true);
                if(conn && conn.open) conn.send({ type: 'msg', content: img, isImg: true });
            };
            reader.readAsDataURL(file);
        }

        function addMessage(content, sender, isImg, subText = "") {
            const chat = document.getElementById('chat-area');
            const div = document.createElement('div');
            div.className = `message ${sender}`;
            
            let html = isImg ? `<img src="${content}">` : content;
            if(subText && subText !== content) {
                html += `<span class="sub-text">${subText}</span>`;
            }
            div.innerHTML = html;
            
            // Insert before typing bubble if it exists
            const typingBubble = document.getElementById('typing-bubble');
            chat.insertBefore(div, typingBubble);
            
            chat.scrollTop = chat.scrollHeight;
        }

        function handleEnter(e) {
            if(e.key === 'Enter') send();
        }

        function setStatus(text, isOnline) {
            document.getElementById('status-text').innerText = text;
            const dot = document.getElementById('status-dot');
            if(isOnline) dot.classList.add('online');
            else dot.classList.remove('online');
        }

        // --- TRANSLATION API ---
        async function translate(text, lang) {
            try {
                const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=Autodetect|${lang}`);
                const data = await res.json();
                return data.responseData.translatedText;
            } catch (e) { return ""; }
        }
    </script>
</body>
</html>
