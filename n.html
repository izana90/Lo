<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Sound & Typing</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #007AFF; /* iOS Blue */
            --bg: #F2F2F7;
            --white: #FFFFFF;
            --gray-bubble: #E9E9EB;
            --green-dot: #34C759;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg); 
            margin: 0; height: 100vh; 
            display: flex; flex-direction: column; 
            overflow: hidden;
        }

        /* --- LOGIN SCREEN --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98);
            z-index: 999; display: flex; align-items: center; justify-content: center;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1); width: 90%; max-width: 320px;
            text-align: center;
        }
        .login-box input, .login-box select {
            width: 100%; padding: 14px; margin: 10px 0;
            border: 1px solid #E5E5EA; border-radius: 12px; font-size: 16px;
            box-sizing: border-box; outline: none; transition: 0.2s;
        }
        .login-box input:focus { border-color: var(--primary); }
        .btn-start {
            width: 100%; padding: 14px; background: var(--primary); color: white;
            border: none; border-radius: 12px; font-size: 16px; font-weight: 600;
            cursor: pointer; margin-top: 10px;
        }

        /* --- MAIN APP --- */
        header {
            background: rgba(255,255,255,0.85); backdrop-filter: blur(20px);
            padding: 15px 20px; border-bottom: 1px solid #E5E5EA;
            display: flex; justify-content: space-between; align-items: center;
            height: 60px; box-sizing: border-box; z-index: 10;
        }
        .user-meta { display: flex; align-items: center; gap: 12px; }
        .avatar { 
            width: 40px; height: 40px; background: #E5E5EA; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-weight: 700; color: #555;
        }
        .status-text { font-size: 13px; color: #8E8E93; display: flex; align-items: center; gap: 6px; }
        .dot { width: 8px; height: 8px; background: #C7C7CC; border-radius: 50%; transition: 0.3s; }
        .dot.online { background: var(--green-dot); box-shadow: 0 0 8px rgba(52, 199, 89, 0.4); }

        select.lang-switch {
            background: #F2F2F7; border: none; padding: 6px 12px; border-radius: 8px; font-size: 12px;
        }

        /* --- CHAT AREA --- */
        #chat-container {
            flex: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 8px;
            scroll-behavior: smooth;
        }
        
        .msg {
            max-width: 70%; padding: 10px 16px; border-radius: 18px;
            font-size: 16px; line-height: 1.4; position: relative;
            word-wrap: break-word; animation: popIn 0.3s ease forwards;
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .msg.me {
            align-self: flex-end; background: var(--primary); color: white;
            border-bottom-right-radius: 4px;
        }
        .msg.partner {
            align-self: flex-start; background: var(--gray-bubble); color: black;
            border-bottom-left-radius: 4px;
        }
        .msg img { max-width: 100%; border-radius: 10px; margin-top: 5px; display: block; }
        
        .translated-sub {
            font-size: 12px; opacity: 0.8; margin-top: 4px; padding-top: 4px;
            border-top: 1px solid rgba(0,0,0,0.1); display: block; font-style: italic;
        }
        .me .translated-sub { border-top-color: rgba(255,255,255,0.3); }

        /* --- TYPING BUBBLE --- */
        #typing-indicator {
            align-self: flex-start; background: var(--gray-bubble);
            padding: 12px 18px; border-radius: 18px; border-bottom-left-radius: 4px;
            display: none; width: fit-content; margin-bottom: 5px;
        }
        .typing-dots { display: flex; gap: 4px; }
        .typing-dots span {
            width: 6px; height: 6px; background: #8E8E93; border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* --- INPUT --- */
        footer {
            padding: 15px; background: var(--white); border-top: 1px solid #E5E5EA;
            display: flex; gap: 12px; align-items: center;
        }
        #message-input {
            flex: 1; padding: 12px 18px; border-radius: 24px; border: 1px solid #E5E5EA;
            font-size: 16px; outline: none; background: #F9F9F9;
        }
        #message-input:focus { background: white; border-color: var(--primary); }
        
        .action-btn {
            background: none; border: none; font-size: 24px; cursor: pointer;
            color: var(--primary); padding: 5px; transition: 0.2s;
        }
        .action-btn:hover { transform: scale(1.1); }

    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="margin: 0 0 20px 0; color: #333;">ðŸ’¬ Connect</h2>
            <input type="text" id="room-id" placeholder="Secret Room Name (e.g. 'sky')">
            <select id="user-role">
                <option value="A">User A</option>
                <option value="B">User B</option>
            </select>
            <button class="btn-start" onclick="initChat()">Join Room</button>
            <p style="font-size: 12px; color: #888;">Both people must use the same Room Name.</p>
        </div>
    </div>

    <header>
        <div class="user-meta">
            <div class="avatar" id="my-avatar">?</div>
            <div>
                <strong id="partner-name">Partner</strong>
                <div class="status-text"><span class="dot" id="status-dot"></span> <span id="status-label">Offline</span></div>
            </div>
        </div>
        <select class="lang-switch" id="translate-lang">
            <option value="none">Translate: Off</option>
            <option value="en">English</option>
            <option value="es">Spanish</option>
            <option value="fr">French</option>
            <option value="hi">Hindi</option>
            <option value="ja">Japanese</option>
        </select>
    </header>

    <div id="chat-container">
        <div id="typing-indicator">
            <div class="typing-dots"><span></span><span></span><span></span></div>
        </div>
    </div>

    <footer>
        <input type="file" id="image-upload" hidden accept="image/*" onchange="sendImage()">
        <button class="action-btn" onclick="document.getElementById('image-upload').click()">ðŸ“·</button>
        <input type="text" id="message-input" placeholder="iMessage..." onkeypress="handleEnter(event)" oninput="broadcastTyping()">
        <button class="action-btn" onclick="sendMessage()">âž¤</button>
    </footer>

    <script>
        // --- VARIABLES ---
        let peer;
        let conn;
        let myId, partnerId;
        let typingTimeout;
        
        // --- SOUND ENGINE (Web Audio API - No External Files) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            if (type === 'send') {
                // High pitch "Swoosh" / "Pop"
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'receive') {
                // Pleasant "Ding"
                osc.type = 'sine';
                osc.frequency.setValueAtTime(500, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.3);
                gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        // --- APP LOGIC ---
        function initChat() {
            const room = document.getElementById('room-id').value.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
            const role = document.getElementById('user-role').value;
            
            if(!room) return alert("Enter a room name!");

            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('my-avatar').innerText = role;

            myId = room + '-' + role;
            partnerId = room + '-' + (role === 'A' ? 'B' : 'A');

            startPeer();
        }

        function startPeer() {
            setUiStatus("Connecting...", false);
            peer = new Peer(myId);

            peer.on('open', (id) => {
                setUiStatus("Waiting...", false);
                connectToPartner(); // Try connecting immediately
            });

            // Handle incoming connection
            peer.on('connection', (c) => {
                bindConnection(c);
            });

            peer.on('error', (err) => console.log("Peer Error:", err));
            peer.on('disconnected', () => {
                setUiStatus("Reconnecting...", false);
                peer.reconnect();
            });
        }

        function connectToPartner() {
            // Only connect if we don't have an active connection
            if (conn && conn.open) return;
            
            const c = peer.connect(partnerId);
            if(c) bindConnection(c);
        }

        function bindConnection(c) {
            // Prevent double binding
            if (conn && conn.open) return; 

            conn = c;

            conn.on('open', () => {
                setUiStatus("Online", true);
                // Send handshake to confirm path
                conn.send({ type: 'handshake' });
            });

            conn.on('data', (data) => {
                handleIncomingData(data);
            });

            conn.on('close', () => {
                setUiStatus("Offline", false);
                conn = null;
                setTimeout(connectToPartner, 3000); // Retry loop
            });
        }

        // --- DATA HANDLER (The Fix) ---
        async function handleIncomingData(data) {
            if (data.type === 'msg') {
                // 1. Hide typing immediately
                toggleTypingBubble(false);
                
                // 2. Play Sound
                playSound('receive');

                // 3. Translate if needed
                let subText = "";
                const lang = document.getElementById('translate-lang').value;
                if(lang !== 'none' && !data.isImg) {
                    subText = await translate(data.content, lang);
                }

                // 4. Show Message
                addMessageToUI(data.content, 'partner', data.isImg, subText);

            } else if (data.type === 'typing') {
                toggleTypingBubble(data.isTyping);
            }
        }

        // --- MESSAGING ---
        function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if(!text) return;

            // 1. Show UI
            addMessageToUI(text, 'me', false);
            playSound('send');

            // 2. Send Network
            if(conn && conn.open) {
                conn.send({ type: 'msg', content: text, isImg: false });
                conn.send({ type: 'typing', isTyping: false }); // Stop typing indicator
            }
            
            input.value = '';
        }

        function sendImage() {
            const file = document.getElementById('image-upload').files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = e.target.result;
                addMessageToUI(img, 'me', true);
                playSound('send');
                if(conn && conn.open) {
                    conn.send({ type: 'msg', content: img, isImg: true });
                }
            };
            reader.readAsDataURL(file);
        }

        // --- TYPING LOGIC (Refined) ---
        function broadcastTyping() {
            if(conn && conn.open) {
                conn.send({ type: 'typing', isTyping: true });
                
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    if(conn && conn.open) conn.send({ type: 'typing', isTyping: false });
                }, 1000);
            }
        }

        function toggleTypingBubble(show) {
            const bubble = document.getElementById('typing-indicator');
            const container = document.getElementById('chat-container');
            
            if(show) {
                bubble.style.display = 'block';
                // Always move to bottom
                container.appendChild(bubble); 
                container.scrollTop = container.scrollHeight;
            } else {
                bubble.style.display = 'none';
            }
        }

        // --- UI HELPERS ---
        function addMessageToUI(content, sender, isImg, subText = "") {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `msg ${sender}`;
            
            let html = isImg ? `<img src="${content}">` : content;
            if(subText && subText !== content) {
                html += `<span class="translated-sub">${subText}</span>`;
            }
            div.innerHTML = html;

            // Insert BEFORE the typing indicator (so typing stays at bottom)
            const bubble = document.getElementById('typing-indicator');
            container.insertBefore(div, bubble);
            
            container.scrollTop = container.scrollHeight;
        }

        function setUiStatus(text, isOnline) {
            document.getElementById('status-label').innerText = text;
            const dot = document.getElementById('status-dot');
            if(isOnline) dot.classList.add('online');
            else dot.classList.remove('online');
        }

        function handleEnter(e) {
            if(e.key === 'Enter') sendMessage();
        }

        // --- TRANSLATION API ---
        async function translate(text, targetLang) {
            try {
                const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=Autodetect|${targetLang}`);
                const data = await res.json();
                return data.responseData.translatedText;
            } catch (e) { return ""; }
        }
    </script>
</body>
</html>
