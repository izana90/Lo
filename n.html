<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mobile Chat Fixed</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #007AFF;
            --bg: #F2F2F7;
            --white: #FFFFFF;
            --gray-bubble: #E9E9EB;
            --green-dot: #34C759;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg); 
            margin: 0; padding: 0;
            /* FIX: Use dynamic height to handle mobile URL bars */
            height: 100vh; height: 100dvh; 
            width: 100vw;
            display: flex; flex-direction: column; 
            overflow: hidden; /* Lock scroll to chat box only */
            position: fixed; /* Prevents whole page bounce on iOS */
            top: 0; left: 0;
        }

        /* --- LOGIN OVERLAY --- */
        #login-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); z-index: 999; 
            display: flex; align-items: center; justify-content: center;
        }
        .login-box {
            background: white; padding: 30px; border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); width: 85%; max-width: 320px;
            text-align: center;
        }
        .login-box input, .login-box select {
            width: 100%; padding: 14px; margin: 10px 0;
            border: 1px solid #E5E5EA; border-radius: 12px; font-size: 16px;
            outline: none; background: #f9f9f9;
        }
        .btn-start {
            width: 100%; padding: 14px; background: var(--primary); color: white;
            border: none; border-radius: 12px; font-size: 16px; font-weight: 600;
            cursor: pointer; margin-top: 10px;
        }

        /* --- HEADER --- */
        header {
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            padding: 10px 15px; border-bottom: 1px solid #E5E5EA;
            display: flex; justify-content: space-between; align-items: center;
            height: 60px; flex-shrink: 0; /* Prevents header shrinking */
            z-index: 10;
        }
        .user-meta { display: flex; align-items: center; gap: 10px; }
        .avatar { 
            width: 36px; height: 36px; background: #E5E5EA; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-weight: 700; color: #555;
        }
        .status-text { font-size: 12px; color: #8E8E93; display: flex; align-items: center; gap: 5px; }
        .dot { width: 8px; height: 8px; background: #C7C7CC; border-radius: 50%; }
        .dot.online { background: var(--green-dot); box-shadow: 0 0 5px var(--green-dot); }
        select.lang-switch { background: #eee; border: none; padding: 5px 10px; border-radius: 8px; font-size: 12px; }

        /* --- CHAT AREA --- */
        #chat-container {
            flex: 1; /* Takes all available space */
            overflow-y: auto; /* Scrollable */
            padding: 15px; 
            display: flex; flex-direction: column; gap: 8px;
            background: var(--white);
            -webkit-overflow-scrolling: touch; /* Smooth scroll on iOS */
        }
        
        .msg {
            max-width: 75%; padding: 10px 14px; border-radius: 18px;
            font-size: 16px; line-height: 1.4; position: relative;
            word-wrap: break-word; animation: popIn 0.2s ease forwards;
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .msg.me { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .msg.partner { align-self: flex-start; background: var(--gray-bubble); color: black; border-bottom-left-radius: 2px; }
        .msg img { max-width: 100%; border-radius: 10px; margin-top: 5px; display: block; }
        .translated-sub { font-size: 11px; opacity: 0.8; margin-top: 4px; padding-top: 4px; border-top: 1px solid rgba(0,0,0,0.1); display: block; font-style: italic; }
        .me .translated-sub { border-top-color: rgba(255,255,255,0.3); }

        /* --- TYPING BUBBLE --- */
        #typing-indicator {
            align-self: flex-start; background: var(--gray-bubble);
            padding: 10px 16px; border-radius: 18px; border-bottom-left-radius: 2px;
            display: none; width: fit-content; margin-bottom: 5px;
        }
        .typing-dots { display: flex; gap: 4px; }
        .typing-dots span { width: 6px; height: 6px; background: #8E8E93; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* --- FOOTER (INPUT) --- */
        footer {
            padding: 10px 15px; background: #F9F9F9; border-top: 1px solid #E5E5EA;
            display: flex; gap: 10px; align-items: center;
            flex-shrink: 0; /* Prevents footer from squishing */
            padding-bottom: env(safe-area-inset-bottom); /* Fix for iPhone X+ home bar */
        }
        #message-input {
            flex: 1; padding: 12px 15px; border-radius: 20px; border: 1px solid #ddd;
            font-size: 16px; outline: none; background: white;
            /* Prevent zoom on focus in iOS */
            transform: translateZ(0); 
        }
        #message-input:focus { border-color: var(--primary); }
        
        .action-btn {
            background: none; border: none; font-size: 24px; cursor: pointer;
            color: var(--primary); padding: 5px; display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="margin: 0 0 15px 0; color: #333;">ðŸ’¬ Chat Login</h2>
            <input type="text" id="room-id" placeholder="Enter Room Name (e.g. 'sky')">
            <select id="user-role">
                <option value="A">User A</option>
                <option value="B">User B</option>
            </select>
            <button class="btn-start" onclick="initChat()">Join Room</button>
            <p style="font-size: 12px; color: #888; margin-top: 15px;">Both must enter same Room Name.</p>
        </div>
    </div>

    <header>
        <div class="user-meta">
            <div class="avatar" id="my-avatar">?</div>
            <div>
                <strong id="partner-name">Partner</strong>
                <div class="status-text"><span class="dot" id="status-dot"></span> <span id="status-label">Offline</span></div>
            </div>
        </div>
        <select class="lang-switch" id="translate-lang">
            <option value="none">Translate: Off</option>
            <option value="en">English</option>
            <option value="es">Spanish</option>
            <option value="fr">French</option>
            <option value="hi">Hindi</option>
            <option value="ja">Japanese</option>
        </select>
    </header>

    <div id="chat-container">
        <div id="typing-indicator">
            <div class="typing-dots"><span></span><span></span><span></span></div>
        </div>
    </div>

    <footer>
        <input type="file" id="image-upload" hidden accept="image/*" onchange="sendImage()">
        <button class="action-btn" onclick="document.getElementById('image-upload').click()">ðŸ“·</button>
        <input type="text" id="message-input" placeholder="Message..." onkeypress="handleEnter(event)" oninput="broadcastTyping()">
        <button class="action-btn" onclick="sendMessage()">âž¤</button>
    </footer>

    <script>
        // --- VARIABLES ---
        let peer, conn, myId, partnerId, typingTimeout;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // --- SOUNDS ---
        function playSound(type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            
            if(type === 'send') {
                osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            } else {
                osc.frequency.setValueAtTime(400, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        // --- LOGIC ---
        function initChat() {
            const room = document.getElementById('room-id').value.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
            const role = document.getElementById('user-role').value;
            if(!room) return alert("Enter a room name!");

            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('my-avatar').innerText = role;

            myId = room + '-' + role;
            partnerId = room + '-' + (role === 'A' ? 'B' : 'A');

            startPeer();
        }

        function startPeer() {
            setUiStatus("Connecting...", false);
            peer = new Peer(myId);
            
            peer.on('open', () => {
                setUiStatus("Waiting...", false);
                connectToPartner();
            });

            peer.on('connection', (c) => bindConnection(c));
            peer.on('disconnected', () => { setUiStatus("Reconnecting...", false); peer.reconnect(); });
        }

        function connectToPartner() {
            if(conn && conn.open) return;
            const c = peer.connect(partnerId);
            if(c) bindConnection(c);
        }

        function bindConnection(c) {
            if(conn && conn.open) return;
            conn = c;

            conn.on('open', () => {
                setUiStatus("Online", true);
                conn.send({ type: 'handshake' }); // Sync connection
            });

            conn.on('data', async (data) => {
                if(data.type === 'msg') {
                    toggleTyping(false);
                    playSound('receive');
                    let sub = "";
                    const lang = document.getElementById('translate-lang').value;
                    if(lang !== 'none' && !data.isImg) sub = await translate(data.content, lang);
                    addMessage(data.content, 'partner', data.isImg, sub);
                } else if(data.type === 'typing') {
                    toggleTyping(data.isTyping);
                }
            });

            conn.on('close', () => {
                setUiStatus("Offline", false);
                conn = null;
                setTimeout(connectToPartner, 3000);
            });
        }

        // --- MESSAGING ---
        function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if(!text) return;

            addMessage(text, 'me', false);
            playSound('send');
            
            if(conn && conn.open) {
                conn.send({ type: 'msg', content: text, isImg: false });
                conn.send({ type: 'typing', isTyping: false });
            }
            input.value = '';
        }

        function sendImage() {
            const file = document.getElementById('image-upload').files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                addMessage(e.target.result, 'me', true);
                playSound('send');
                if(conn && conn.open) conn.send({ type: 'msg', content: e.target.result, isImg: true });
            };
            reader.readAsDataURL(file);
        }

        function addMessage(content, sender, isImg, subText = "") {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `msg ${sender}`;
            
            let html = isImg ? `<img src="${content}">` : content;
            if(subText && subText !== content) html += `<span class="translated-sub">${subText}</span>`;
            div.innerHTML = html;

            const bubble = document.getElementById('typing-indicator');
            container.insertBefore(div, bubble);
            container.scrollTop = container.scrollHeight;
        }

        // --- TYPING ---
        function broadcastTyping() {
            if(conn && conn.open) {
                conn.send({ type: 'typing', isTyping: true });
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    if(conn && conn.open) conn.send({ type: 'typing', isTyping: false });
                }, 1000);
            }
        }

        function toggleTyping(show) {
            const bubble = document.getElementById('typing-indicator');
            const container = document.getElementById('chat-container');
            if(show) {
                bubble.style.display = 'block';
                container.appendChild(bubble); // Always move to bottom
                container.scrollTop = container.scrollHeight;
            } else {
                bubble.style.display = 'none';
            }
        }

        // --- UTILS ---
        function setUiStatus(text, isOnline) {
            document.getElementById('status-label').innerText = text;
            const dot = document.getElementById('status-dot');
            if(isOnline) dot.classList.add('online'); else dot.classList.remove('online');
        }

        function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }
        
        async function translate(text, lang) {
            try {
                const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=Autodetect|${lang}`);
                const data = await res.json();
                return data.responseData.translatedText;
            } catch(e) { return ""; }
        }
    </script>
</body>
</html>
