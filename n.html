<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Us.</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@1,300;1,600&family=Manrope:wght@300;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Theme: Midnight Bloom */
            --bg-deep: #1a0b12; /* Deep Aubergine */
            --bg-glass: rgba(45, 20, 30, 0.6);
            --accent-rose: #b76e79; /* Muted Rose */
            --accent-gold: #d4af37;
            --text-cream: #f3e5f5;
            --text-muted: #a69b9e;
            --bubble-me: #6d4c41; /* Warm Brown/Rose */
            --bubble-you: rgba(255, 255, 255, 0.08);
            
            --font-display: 'Cormorant Garamond', serif;
            --font-body: 'Manrope', sans-serif;
            
            --ease-out-back: cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; height: 100vh;
            background-color: var(--bg-deep);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(183, 110, 121, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(212, 175, 55, 0.08) 0%, transparent 40%);
            color: var(--text-cream);
            font-family: var(--font-body);
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- ANIMATIONS --- */
        @keyframes drift { 0% { transform: translateY(10px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 rgba(183, 110, 121, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(183, 110, 121, 0); } 100% { box-shadow: 0 0 0 0 rgba(183, 110, 121, 0); } }

        /* --- LOGIN SCREEN (The Invitation) --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(26, 11, 18, 0.95);
            backdrop-filter: blur(20px);
            z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .login-card {
            width: 85%; max-width: 380px;
            text-align: center;
            animation: drift 1s var(--ease-out-back) forwards;
        }

        h1 {
            font-family: var(--font-display);
            font-style: italic;
            font-size: 3.5rem;
            margin: 0 0 10px 0;
            color: var(--accent-rose);
            text-shadow: 0 0 20px rgba(183, 110, 121, 0.3);
            letter-spacing: -1px;
        }

        p.subtitle { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 2rem; letter-spacing: 1px; text-transform: uppercase; }

        .input-group { position: relative; margin-bottom: 1.5rem; opacity: 0; animation: drift 0.8s ease forwards 0.3s; }
        
        input, select {
            width: 100%; padding: 15px 0;
            background: transparent; border: none;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            color: var(--text-cream); font-family: var(--font-body); font-size: 1.1rem;
            transition: 0.3s; text-align: center;
        }
        
        input:focus { border-bottom-color: var(--accent-rose); }
        input::placeholder { color: rgba(255,255,255,0.2); font-family: var(--font-display); font-style: italic; }
        select { color: var(--accent-rose); cursor: pointer; }

        button.primary-btn {
            margin-top: 20px;
            padding: 15px 40px;
            background: linear-gradient(135deg, var(--accent-rose), #8e4d58);
            color: white; border: none; border-radius: 50px;
            font-family: var(--font-body); font-weight: 700; letter-spacing: 1px;
            cursor: pointer; box-shadow: 0 10px 30px rgba(183, 110, 121, 0.3);
            transition: transform 0.2s;
            opacity: 0; animation: drift 0.8s ease forwards 0.5s;
        }
        button.primary-btn:hover { transform: scale(1.05); }

        /* --- MAIN APP UI --- */
        #app-container {
            flex: 1; display: flex; flex-direction: column;
            max-width: 800px; margin: 0 auto; width: 100%;
            opacity: 0; transition: opacity 1s;
        }

        /* HEADER */
        header {
            padding: 20px 25px;
            display: flex; justify-content: space-between; align-items: flex-end;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .header-title { font-family: var(--font-display); font-size: 1.8rem; font-style: italic; color: var(--accent-rose); }
        
        .status-pill {
            display: flex; align-items: center; gap: 8px;
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px;
            color: var(--text-muted);
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #444; transition: 0.3s; }
        .dot.active { background: #27ae60; box-shadow: 0 0 10px #27ae60; }
        .dot.connecting { background: var(--accent-gold); animation: pulse-glow 2s infinite; }

        /* TRANSLATION BAR (Hidden by default, elegant toggle) */
        .settings-bar {
            padding: 10px 25px;
            background: rgba(0,0,0,0.2);
            display: flex; justify-content: flex-end;
        }
        #lang-select {
            width: auto; padding: 5px; font-size: 0.8rem; border: none; color: var(--text-muted);
            text-align-last: right; text-transform: uppercase; letter-spacing: 1px;
        }

        /* CHAT AREA */
        #chat-stream {
            flex: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 20px;
            scroll-behavior: smooth;
        }
        
        /* SCROLLBAR */
        #chat-stream::-webkit-scrollbar { width: 5px; }
        #chat-stream::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

        .msg-row { display: flex; width: 100%; opacity: 0; animation: drift 0.4s var(--ease-out-back) forwards; }
        .msg-row.me { justify-content: flex-end; }
        .msg-row.partner { justify-content: flex-start; }

        .bubble {
            max-width: 75%; padding: 12px 18px;
            font-size: 1rem; line-height: 1.5;
            position: relative;
        }
        
        .me .bubble {
            background: var(--bubble-me);
            color: white;
            border-radius: 18px 18px 2px 18px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .partner .bubble {
            background: var(--bubble-you);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 18px 18px 18px 2px;
            color: var(--text-cream);
        }

        .bubble img {
            border-radius: 10px; margin-top: 10px; max-width: 100%;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
        }

        .translation-sub {
            display: block; margin-top: 6px; padding-top: 6px;
            border-top: 1px solid rgba(255,255,255,0.15);
            font-family: var(--font-display); font-style: italic; font-size: 0.9rem; opacity: 0.8;
        }

        /* TYPING INDICATOR (Heartbeat) */
        .typing-area {
            height: 20px; padding: 0 25px; margin-bottom: 5px;
            font-size: 0.7rem; color: var(--accent-rose); letter-spacing: 1px;
            display: flex; align-items: center; gap: 5px; opacity: 0; transition: opacity 0.3s;
        }
        .typing-area.visible { opacity: 1; }
        .heart-pulse { display: inline-block; animation: scaleIn 0.5s infinite alternate; }
        @keyframes scaleIn { from { transform: scale(1); } to { transform: scale(1.3); } }

        /* INPUT AREA */
        footer {
            padding: 20px;
            background: rgba(26, 11, 18, 0.8);
            backdrop-filter: blur(10px);
            display: flex; gap: 15px; align-items: center;
        }
        
        .icon-btn {
            background: transparent; border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-muted); width: 45px; height: 45px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            transition: 0.2s; font-size: 1.2rem;
        }
        .icon-btn:hover { border-color: var(--accent-rose); color: var(--accent-rose); }

        #msg-input {
            flex: 1; padding: 12px 20px;
            background: rgba(255,255,255,0.05); border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.1);
            color: white; text-align: left;
        }
        #msg-input:focus { border-color: var(--accent-rose); background: rgba(255,255,255,0.08); }

    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-card">
            <h1>Us.</h1>
            <p class="subtitle">A private space for two</p>
            
            <div class="input-group">
                <input type="text" id="pass" placeholder="our secret word" autocomplete="off">
            </div>
            
            <div class="input-group" style="animation-delay: 0.4s">
                <select id="role">
                    <option value="A" style="background:#1a0b12">I am Partner A</option>
                    <option value="B" style="background:#1a0b12">I am Partner B</option>
                </select>
            </div>

            <button class="primary-btn" onclick="enterApp()">Connect Hearts</button>
        </div>
    </div>

    <div id="app-container">
        <header>
            <div class="header-title">Our Space</div>
            <div class="status-pill">
                <span id="status-text">Disconnected</span>
                <div class="dot" id="status-dot"></div>
            </div>
        </header>

        <div class="settings-bar">
            <select id="lang-select" onchange="saveLang()">
                <option value="none" style="background:#1a0b12">Translate: Off</option>
                <option value="en" style="background:#1a0b12">Translate: English</option>
                <option value="es" style="background:#1a0b12">Translate: Spanish</option>
                <option value="fr" style="background:#1a0b12">Translate: French</option>
                <option value="hi" style="background:#1a0b12">Translate: Hindi</option>
                <option value="ja" style="background:#1a0b12">Translate: Japanese</option>
            </select>
        </div>

        <div id="chat-stream">
            </div>

        <div class="typing-area" id="typing-indicator">
            <span class="heart-pulse">❤️</span> Partner is typing...
        </div>

        <footer>
            <input type="file" id="file-upload" hidden accept="image/*" onchange="sendImage()">
            <button class="icon-btn" onclick="document.getElementById('file-upload').click()">+</button>
            <input type="text" id="msg-input" placeholder="Whisper something..." oninput="handleTyping()" onkeypress="handleEnter(event)">
            <button class="icon-btn" style="background: var(--accent-rose); color: white; border: none;" onclick="sendMessage()">➤</button>
        </footer>
    </div>

    <script>
        // --- LOGIC ---
        let peer, conn, myId, partnerId, typingTimer;

        function enterApp() {
            const pass = document.getElementById('pass').value.toLowerCase().replace(/[^a-z0-9]/g, '');
            const role = document.getElementById('role').value;
            
            if (!pass) return; // Simple validation

            // Animation out
            const overlay = document.getElementById('login-overlay');
            overlay.style.opacity = '0';
            setTimeout(() => overlay.style.display = 'none', 800);
            
            document.getElementById('app-container').style.opacity = '1';

            // Identity Setup
            myId = pass + "-" + role;
            partnerId = pass + "-" + (role === "A" ? "B" : "A");

            const savedLang = localStorage.getItem('chat_lang');
            if(savedLang) document.getElementById('lang-select').value = savedLang;

            initNetwork();
        }

        function initNetwork() {
            setStatus("Connecting...", "connecting");
            peer = new Peer(myId);

            peer.on('open', () => {
                setStatus("Waiting for them...", "connecting");
                attemptConnect();
            });

            peer.on('connection', (c) => {
                bindConnection(c);
            });

            peer.on('disconnected', () => {
                setStatus("Reconnecting...", "connecting");
                setTimeout(() => peer.reconnect(), 2000);
            });
        }

        function attemptConnect() {
            if (conn) return;
            let c = peer.connect(partnerId);
            if(c) bindConnection(c);
        }

        function bindConnection(c) {
            conn = c;
            conn.on('open', () => {
                setStatus("Together", "active");
            });

            conn.on('data', async (data) => {
                if (data.type === 'typing') {
                    const el = document.getElementById('typing-indicator');
                    if (data.active) el.classList.add('visible');
                    else el.classList.remove('visible');
                } 
                else if (data.type === 'msg') {
                    // Translation Logic
                    let subText = "";
                    const targetLang = document.getElementById('lang-select').value;
                    
                    if (targetLang !== 'none' && !data.isImg) {
                        subText = await translate(data.content, targetLang);
                    }
                    
                    addMessage(data.content, 'partner', data.isImg, subText);
                }
            });

            conn.on('close', () => {
                setStatus("Alone (Offline)", "");
                conn = null;
                setTimeout(attemptConnect, 3000);
            });
        }

        function setStatus(text, state) {
            document.getElementById('status-text').innerText = text;
            const dot = document.getElementById('status-dot');
            dot.className = 'dot ' + state;
        }

        // --- MESSAGING ---
        function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text) return;

            addMessage(text, 'me', false);
            if (conn && conn.open) {
                conn.send({ type: 'msg', content: text, isImg: false });
                conn.send({ type: 'typing', active: false });
            }
            input.value = '';
        }

        function sendImage() {
            const file = document.getElementById('file-upload').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = e.target.result;
                addMessage(img, 'me', true);
                if (conn && conn.open) conn.send({ type: 'msg', content: img, isImg: true });
            };
            reader.readAsDataURL(file);
        }

        function addMessage(content, sender, isImg, translatedText = "") {
            const stream = document.getElementById('chat-stream');
            const row = document.createElement('div');
            row.className = `msg-row ${sender}`;
            
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            
            let innerHTML = isImg ? `<img src="${content}">` : content;
            if (translatedText && translatedText !== content) {
                innerHTML += `<span class="translation-sub">${translatedText}</span>`;
            }
            
            bubble.innerHTML = innerHTML;
            row.appendChild(bubble);
            stream.appendChild(row);
            
            // Smooth scroll to bottom
            stream.scrollTop = stream.scrollHeight;
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }

        function handleTyping() {
            if (conn && conn.open) {
                conn.send({ type: 'typing', active: true });
                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => {
                    conn.send({ type: 'typing', active: false });
                }, 1000);
            }
        }

        async function translate(text, lang) {
            try {
                const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=Autodetect|${lang}`);
                const data = await res.json();
                return data.responseData.translatedText;
            } catch (e) { return ""; }
        }

        function saveLang() {
            localStorage.setItem('chat_lang', document.getElementById('lang-select').value);
        }
    </script>
</body>
</html>
